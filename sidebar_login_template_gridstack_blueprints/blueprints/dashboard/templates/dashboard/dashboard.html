{% extends "base.html" %}
{% block title %} Dashboard {% endblock %}

<!-- Specific Page CSS goes HERE  -->
{% block stylesheets %}
<style type="text/css">
  .grid-stack { background: #000002; }
  .grid-stack-item-content { background-color: #222c2a; }
</style>
<link rel="stylesheet" href="/static/dashboard/gridstack/gridstack.min.css"/>
{% endblock stylesheets %}

{% block content %}
<div class="container-fluid">
  <h1>Serialization demo</h1>
  <a onClick="loadGrid()" class="btn btn-primary" href="#">Load</a>
  <a onClick="saveFullGrid()" class="btn btn-primary" href="#">Save Full</a>
  <a onClick="loadFullGrid()" class="btn btn-primary" href="#">Load Full</a>
  <a onClick="clearGrid()" class="btn btn-primary" href="#">Clear</a>
  <br/><br/>
  <div id="gridCont"><div class="grid-stack"></div></div>
  <hr/>
  <textarea id="saved-data" cols="100" rows="20" readonly="readonly"></textarea>
</div>
{% endblock content %}

<!-- Specific Page JS goes HERE  -->
{% block javascripts %}
<script src="/static/dashboard/events.js"></script>
<script src="/static/dashboard/gridstack/gridstack-h5.js"></script>

<script type="text/javascript">
  let grid = GridStack.init({
    minRow: 1, // don't let it collapse when empty
    cellHeight: '7rem'
  });

  grid.on('added removed change', function(e, items) {
    let str = '';
    items.forEach(function(item) { str += ' (x,y)=' + item.x + ',' + item.y; });
    console.log(e.type + ' ' + items.length + ' items:' + str );
  });

  let serializedData = [
    {x: 0, y: 0, w: 2, h: 2, id: '0'},
    {x: 3, y: 1, h: 2, id: '1', content: "<button onclick=\"alert('clicked!')\">Press me</button>"},
    {x: 4, y: 1, id: '2'},
    {x: 2, y: 3, w: 3, id: '3'},
    {x: 1, y: 3, id: '4'}
  ];
  serializedData.forEach((n, i) =>
    n.content = `<button onClick="grid.removeWidget(this.parentNode.parentNode)">X</button><br> ${i}<br> ${n.content ? n.content : ''}`);
  let serializedFull;

  // 2.x method - just saving list of widgets with content (default)
  loadGrid = function() {
    grid.load(serializedData, true); // update things
  }

  // 3.1 full method saving the grid options + children (which is recursive for nested grids)
  saveFullGrid = function() {
    serializedFull = grid.save(true, true);
    serializedData = serializedFull.children;
    document.querySelector('#saved-data').value = JSON.stringify(serializedFull, null, '  ');
  }

  // 3.1 full method to reload from scratch - delete the grid and add it back from JSON
  loadFullGrid = function() {
    if (!serializedFull) return;
    grid.destroy(true); // nuke everything
    grid = GridStack.addGrid(document.querySelector('#gridCont'), serializedFull)
  }

  clearGrid = function() {
    grid.removeAll();
  }

  loadGrid();
</script>
{% endblock javascripts %}
